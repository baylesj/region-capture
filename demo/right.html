<html>
  <head> </head>
  <body>
    <h1>Video Conferencing App</h1>
    <br /><br /><br />
    <video id="video" autoplay playsinline style="border: none"></video>
    <br /><br /><br />
    <button id="button0" onclick="OnSourceSelected(0);">Source #1</button>
    <button id="button1" onclick="OnSourceSelected(1);">Source #2</button>
    <button id="uncropped" onclick="OnUncroppedSelected();">Uncropped</button>
    <br />
    <p>
      If you can observe a shimmering effect, that's an unrelated issue. Get around it by popping
      into picture-in-picture mode.
    </p>
    <button id="pipButton" onclick="OnPipClicked();" disabled>PiP</button>
    <script>
      const video = document.getElementById("video");
      const pipButton = document.getElementById("pipButton");
      let track;
      let cropIDs = [];
      let pip;

      async function MaybeStartCapturing() {
        if (!track || track.readyState != "live") {
          try {
            video.srcObject = await navigator.mediaDevices.getDisplayMedia({
              preferCurrentTab: true,
              cursor: "never", // TODO: crbug.com/1266126
            });
            [track] = video.srcObject.getVideoTracks();
            track.onended = () => {
              pipButton.disabled = true;
              video.srcObject = undefined;
              if (document.pictureInPictureElement) {
                document.exitPictureInPicture();
              }
            };
          } catch (e) {
            // TODO
            console.error(`${e}`);
            return false;
          }
        }
        pipButton.disabled = false;
        return true;
      }

      function IsReady() {
        return cropIDs.length == 2;
      }

      async function OnSourceSelected(source) {
        video.style = "border: none;";
        if (IsReady() && (await MaybeStartCapturing())) {
          video.pause();
          await track.cropTo(cropIDs[source]);
          video.play();
        }
      }

      async function OnUncroppedSelected() {
        if (IsReady() && (await MaybeStartCapturing())) {
          // TODO: This should not be hard-coded, just capped to the size of the div.
          video.style = "border: none; width: 500px; height: 500px;";
          video.pause();
          track.cropTo("");
          video.play();
        }
      }

      function OnPipClicked() {
        video.requestPictureInPicture();
      }

      function onBroadcastChannelMessage(serializedMessage) {
        console.log(`Got ${serializedMessage.data}`);
        try {
          const msg = JSON.parse(serializedMessage.data);
          cropIDs.push(msg.cropID);
        } catch (error) {
          console.error(`${error}`);
        }
      }

      const broadcastChannel = new BroadcastChannel("region-capture-demo");
      broadcastChannel.onmessage = onBroadcastChannelMessage;
    </script>
  </body>
</html>
